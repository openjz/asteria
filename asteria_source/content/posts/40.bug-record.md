---
title: "一些开发过程中遇到的奇怪问题"
date: 2024-07-23T09:11:34+08:00
draft: false

tags: ["问题记录"]
categories: ["编程"]
---

## ssl socket读数据总是会卡住

需求是要给一个开源库中的socket通信加入ssl/tls层，这个第三方库实现了一套nfs协议，用于局域网文件共享

ssl/tls层是用openssl库实现的，测试过程中遇到了一个问题，在传输大文件的时候（几十MB以上），传输过程总是会卡住，百思不得其解

仔细分析日志后发现传输过程卡在了ssl socket提供的peek函数上，查看openssl文档后发现，openssl的ssl socket不是流式传输，是以包为单位的传输，一个包最大16KB，openssl内部的read buffer中的数据量一旦达到了16KB，如果不把这些数据读走是peek不到更多数据的

后来对peek操作做了一个二次封装，在代码中维护了一个临时的buffer，把peek到的数据先读到buffer里，这样就不会导致程序卡在peek上了

## 编译环境从win10 sdk降级到win 8sdk后，进程一启动就卡死

项目最开始的开发环境是win10 sdk，vs2022(v143)工具集，程序工作一切正常，后来要将项目作为插件集成到另外一个平台，为了兼容将项目的开发环境降级到win8 sdk，vs2015(v140)工具集，降级后发现进程一启动就卡死

在调试模式下运行发现，总是卡在创建一个线程的地方，这个创建线程的位置比较特殊，是写在了一个dll的全局对象的构造函数里，这意味着dll被加载的时候会触发线程创建的操作

经过查阅资料得知，在windows sdk的早期版本中，是不允许在dll加载的时候创建线程的，会造成dll加载死锁，然后我们把创建线程改为由上层调用函数触发，解决了问题