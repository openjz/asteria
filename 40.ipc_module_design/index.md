# 进程间通信（IPC）模块的设计思路


## 一些细节问题

不要混淆资源释放（resource release）和停止/断开（stop/disconnect）操作，stop操作是对用户暴露的，resource release是内部操作

资源释放操作通常应当在connect/start失败时或read/write失败时触发，目的是为这些失败操作做收尾，降低用户侧代码的复杂度，如果这些操作交给用户侧代码来做，会导致资源释放操作在用户侧代码分散得到处都是，使用户维护困难，用户通常也并不乐意做这些额外的资源释放操作

例如，如果我们给用户提供了一个start功能，start内部依次建立了多个连接，只要有一个连接失败，就终止start，并返回错误。如果其中一个连接失败，我们不去做任何资源释放操作的话，就意味着前面已成功建立的连接并没有被关闭，用户需要在start返回错误时调用一次stop去断开成功的连接，这对用户来说很奇怪，明明start没有成功，为什么要我去调用一次stop

## 设计一个IPC模块要考虑什么

在近两年的工作中，我为多个软件系统设计了很多不同种类的IPC模块，它们的进程间通信方式各不相同，有的是基于低功耗蓝牙的，有的是基于命名管道的，有的是基于tcp socket的，有的是基于ssl socket的，这些模块的IPC方式虽然不同，但它们的设计思路在很多地方是共通的。

设计一个IPC模块要考虑以下内容：
- 需要对上层暴露哪些接口？
- 一对一还是一对多？
- 同步/异步，阻塞/非阻塞
- 如何准确地判断连接状态，尤其是连接是否断开，由谁断开
- 客户端和服务端行为的差异
- 通信是基于流的还是基于消息的
- 接口的可重入性和多线程同步
- 并发性能（这个话题很大很复杂）
